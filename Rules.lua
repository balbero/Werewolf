--[[
BUT DU JEU
Pour les Villageois: éliminer les Loups-Garous
Pour les Loups-Garous: éliminer les Villageois

LES PERSONNAGES
Les Loups-Garous:
Chaque nuit, ils dévorent un Villageois. Le jour ils essaient de masquer leur identité nocturne pour échapper à la vindicte populaire. Ils sont 1, 2, 3 ou 4 suivant le nombre de joueurs et les variantes appliquées.

Les Villageois (tous ceux qui ne sont pas Loups-Garous):
Chaque nuit, l'un d'entre eux est dévoré par les Loups-Garous. Ce joueur est éliminé du jeu.
Les Villageois survivant se réunissent le lendemain matin et essaient de remarquer , chez les autres joueurs, les signes qui trahiraient leur identité nocturne de mangeur d'homme. Après discussion, ils votent l'éxécution d'un suspect qui sera éliminé du jeu.

Le simple Villageois:
Il n'a aucune compétence particulière. Ses seules armes sont la capacité d'analyse des comportements pour identifier les Loups Garous et la force de conviction pour empêcher l'exécution de l'innocent qu'il est.

La voyante:
Chaque nuit, elle découvre la vraie personnalité d'un joueur de son choix. 
Elle doit aider les autres villageois, mais rester discrète pour ne pas être démasquée par les Loups-garous.


Le Chasseur:
S'il se fait dévorer par les Loups Garous ou exécuter malencontreusement par les joueurs, le Chasseur a le pouvoir de répliquer avant de rendre l'âme, en éliminant immédiatement n'importe quel autre joueur de son choix.

Cupidon:
En décochant ses célèbres flèches magique, Cupidon a le pouvoir de rendre 2 personnes amoureuses à jamais.
La première nuit (tour préliminaire), il désigne les 2 joueurs (ou joueuses ou 1 joueur et 1 joueuse) amoureux. Cupidon peut, s'il le veut, se désigner comme l'un des Amoureux.
Si l'un des amoureux est éliminé, l'autre meurt de chagrin immédiatement. Un Amoureux ne doit jamais voter contre son aimé (même pour faire semblant !)
Attention: Si l'un des deux Amoureux est un Loup-Garou et l'autre un Villageois, le but de la partie change pour eux. Pour vivre en paix leur amour et gagner la partie, ils doivent éliminer tous les autres joueurs , Loups-Garous et Villageois, en respectant les règles du jeu.

La Sorcière:
Elle sait concocter 2 potions extrèmement puissantes:
Une potion de guérison, pour ressusciter le joueur tué par les Loups-Garous, une potion d'empoisonnement, utilisée la nuit pour éliminer un joueur. La sorcière ne peut utiliser chaque potion qu'une seule fois dans la partie. Elle peut se servir de ses 2 potions dans la même nuit. Le matin suivant il pourra, suivant l'usage de ce pouvoir, y avoir 0 mort, 1 mort ou 2 morts. La sorcière peut utiliser les potions à son profit, et donc se guérir elle-même.
Si au bout d'un certain nombre de parties, vous trouvez ce personnage trop puissant, limitez ses pouvoirs à une seule potion pour la partie.

La Petite Fille:
La Petite Fille peut, en entrouvrant les yeux, espionner les Loups Garous pendant leur réveil. Si elle se fait surprendre par un des Loups-Garous, elle meurt immédiatement (en silence), à la place de la victime désignée. Le Petite Fille ne peut espionner que la nuit, durant le tour d'éveil des Loups-Garous.

Le Capitaine:
Cette carte est confiée à un des joueurs, en plus de se carte de personnage. 
Le Capitaine est élu par vote, à la majorité relative. 
On ne peut refuser l'honneur d'être capitaine. 
Dorénavant, les votes de ce joueur comptent pour 2 voix. 
Si ce joueur se fait éliminer, dans son dernier souffle il désigne son successeur.

Le Voleur:
Si on veut jouer le Voleur, il faut ajouter deux cartes Simples Villageois en plus de toutes celles déja choisies.
Après disttribution, les deux cartes non distribuées sont placées au centre de la table face cachée. 
La première nuit, le voleur pourra prendre connaissance de ses deux cartes, et échanger sa carte contre l'une des deux autres. 
Si ces deux cartes sont des Loups Garous, il est obligé d'échanger sa carte contre un des deux Loups Garous. 
Il jouera désormais ce personnage jusqu'à la fin de la partie.

Distribution des personnages pour parties simplifiées
2 Loups-garous (ou plus selon le nombre de joueur)
La voyante
Les simples Villageois (en nombre suffisant)



TOURS DE JEU
MISE EN PLACE
Les joueurs désignent ou tirent au sort un meneur de jeu qui ne joue pas, mais dirige la partie. Pour les premières parties, quelqu'un qui connaît bien le jeu ou celui qui a déchiffré la règle ou un habile meneur de groupe sera le plus à même de restituer la meilleure ambiance.
Le meneur de jeu distribue à chaque joueur 1 carte personnage face cachée. Chaque joueur regarde discrètement son personnage, puis repose sa carte face cachée devant lui.

Le meneur endort le village.
Le meneur dit: "C'est la nuit tout le village s'endort, les joueurs ferment les yeux".
Tous les joueurs baissent la tête et ferment les yeux. Puis selon le choix des personnages en jeu, le meneur appelle les différents personnages.

TOUR DE PRÉPARATION (sauf parties simplifiées)
- Le meneur appelle le Voleur:
Le meneur dit: "le Voleur se réveille !". Le joueur qui possède la carte Voleur, ouvre les yeux et regarde discrètement les deux cartes cachées au milieu, puis change éventuellement de personnage.
Le meneur dit : "Le Voleur se rendort". Le Voleur referme les yeux.

- Le meneur appelle Cupidon
Le meneur dit: "Cupidon se réveille !". Cupidon ouvre les yeux et désigne deux joueurs (dont éventuellement lui-même). Le meneur fait le tour de la table et touche discrètement le dos des deux Amoureux.
Le meneur dit: "Cupidon se rendort". Cupidon referme les yeux.

- Le meneur appelle les Amoureux
Le meneur dit: "les Amoureux se réveillent, se reconnaissent, et se rendorment !". 
Ils ne se montrent pas leur carte de sorte que chacun ignore la véritable personnalité de l'être aimé. 
Puis le meneur suit le tour normal.

TOUR NORMAL
II varie selon le choix des personnages en jeu et leur survie dans la partie, mais les personnages sont toujours appelés dans l'ordre suivant:

1 - Le meneur appelle la Voyante.
Le meneur dit: "la Voyante se réveille, et désigne un joueur dont elle veut sonder la véritable personnalité !".
Le meneur montre à la Voyante la face cachée de la carte du joueur que la Voyante a désigné.
Le meneur dit: "La Voyante se rendort". La Voyante referme les yeux.

2 - Le meneur appelle les Loups-Garous
Le meneur dit: "les Loups-Carous se réveillent, se reconnaissent et désignent une nouvelle victime !!!".
Les Loups-Garous (et eux seulement) lèvent la tête, ouvrent les yeux, se concertent silencieusement et désignent une victime. Durant ce tour, la Petite Fille peut espionner les Loups-Garous (en entrouvrant les yeux discrètement). Elle n'y est pas obligée.
Si elle se fait prendre, les Loups-Garous ont le droit de changer d'avis et elle meurt à la place de la victime éventuellement choisie.
Le meneur dit: "les Loups-Garous repus se rendorment et rêvent de prochaines victimes savoureuses !".
Les Loups-Garous ferment les yeux.

3 - Le meneur appelle la Sorcière
Le meneur dit: "la Sorcière se réveille, je lui montre la victime des Loups-Garous. Va-t-elle user de sa potion de guérison, ou d'empoisonnement ?"
Le meneur montre à la Sorcière la victime des Loups-Garous. La Sorcière n'est pas obligée d'user de son pouvoir à un tour spécifique. 
Si elle utilise une potion, elle doit désigner au meneur sa cible avec le pouce tendu vers le haut pour la guérison, ou vers le bas pour I'empoisonnement. 
Le meneur révélera son effet éventuel le matin suivant.

4 - Le meneur réveille tout le village.
Le meneur dit: "c'est le matin, le village se réveille, tout le monde se réveille et ouvre les yeux, tout le monde sauf..."
Le meneur désigne alors le ou les joueurs qui ont été Victimes des Loups-Garous ou de la Sorcière durant la nuit.
Ce ou ces joueurs révèlent leur carte car ils sont éliminés du jeu. Il ne pourront plus communiquer avec les autres joueurs de quelque manière que ce soit. Si un de ces joueurs est le Chasseur, il a le droit de répliquer et de tuer immédiatement un autre joueur de son choix.
Si un des joueurs est un des deux Amoureux, l'autre Amoureux meurt de chagrin immédiatement.
Si un des joueurs est le Capitaine, il désigne son successeur.

5 - Le village débat des suspects.
Le meneur anime et relance les débats.
Un bruit suspect pendant la nuit, un comportement bizarre par rapport à un autre joueur, ou une façon de voter toujours identique de certains villageois: voici des exemples d'indices qui peuvent laisser suspecter certains joueurs d'être Loups-Garous.
Au cours de cette phase il ne faut pas perdre de vue que les objectifs de chacun sont différents:
- Chaque Villageois tente de démasquer un Loup-Garou et de faire voter contre lui.
- Les Loups-Garous doivent se faire passer pour des villageois.
- La Voyante ainsi que la Petite Fille doivent aider les autres Villageois, mais sans mettre trop tôt leur vie en danger en exposant leur identité.
- Les Amoureux doivent se protéger l'un l'autre.
Chacun a le droit de se faire passer pour un autre. Cette phase est le cœur du jeu. Faites briller vos talents de tribun, bluffez ou dites la vérité, mais soyez toujours crédible.
Croyez-nous, on finit toujours par se dévoiler d'une façon ou d'une autre, et les soupçons finissent toujours par tomber juste. Enfin, presque toujours !

6 - Le village vote.
Les joueurs doivent éliminer un joueur suspecté d'être un Loup-Garou.
Au signal du meneur, chaque joueur pointe son doigt dans la direction du joueur qu'il souhaite éliminer. Le joueur qui a la majorité des voix est éliminé. N'oubliez pas que la voix du Capitaine compte double.
En cas d'égalité, s'il est présent, le vote du Capitaine désigne la victime. Sinon, les joueurs votent à nouveau (y compris les joueurs en cause) pour départager les ex-aequo.
S'il y a toujours égalité, aucun joueur n'est éliminé.
Le joueur éliminé révèle sa carte et ne pourra plus communiquer avec les autres joueurs d'aucune manière.

7 - Le village S'endort
Le meneur dit : "c'est la nuit, les survivants se rendorment !",
les joueurs referment les yeux. (Les joueurs éliminés se taisent, surtout quand ils découvrent qui sont vraiment les Loups-Garous...). Le jeu reprend au début du tour normal, étape 1.


CONDITIONS DE VICTOIRE
Les Villageois gagnent dès qu'ils réussissent à éliminer le dernier Loup-Garou.
Les Loups Garous gagnent s'ils éliminent le dernier des villageois.
Cas particulier:
si les Amoureux sont 1 Loup-Garou + 1 Villageois, ils gagnent dès qu'ils ont éliminé tous les autres.


CONSEILS AU MENEUR
Votre rôle est fondamental: de votre talent dépend l'ambiance du jeu. Grâce à vous les joueurs vont passer un bon moment. N'hésitez pas à créer une atmosphère d'angoisse. Installez un suspense quand vous révélez les victimes des Loups-Garous. N'hésitez pas à relancer les débats s'ils s'épuisent.

Les phrases d'appel nocturne des personnages vous sont données en exemple. Quand vous aurez bien maîtrisé la technique, laissez-vous aller à un délire plus personnel.
Avec des joueurs expérimentés, même si vous n'êtes pas très nombreux, n'hésitez pas à utiliser les villageois avec des pouvoirs spéciaux, cela ajoute de l'intérêt aux parties.
Avec des joueurs débutants introduisez progressivement les autres cartes personnages.

L'essentiel du plaisir est dans l'ambiance.
Les parties sont relativement courtes, faites-en plusieurs dans la même soirée et variez les personnages.

Points de procédures importants:
- Lorsque vous parlez, faites très attention à ne pas laisser passer d'indices sur l'identité des personnages, ex: "j'appelle le Voyant... heu, pardon, la Voyante"
- La nuit, quand vous vous adressez aux personnages appelés, ne dirigez pas votre voix uniquement vers eux, les joueurs pourraient en déduire leur position !
- Si les Loups-Garous n'arrivent pas à se décider, tant pis pour eux, il n'y aura pas de mort cette nuit là.
- Si on joue la Petite Fille, les joueurs ne doivent pas baisser la tête, ni mettre les mains devant les yeux.
- Lorsque la Voyante espionne, feignez de retourner les cartes de tous les joueurs.
- Faites le tour complet de la table pour désigner les Amoureux.
- Vous pouvez attendre quelques tours avant de mettre aux voix le poste de Capitaine, le temps que les joueurs se fassent une opinion sur leurs congénères.


CONSEILS AUX JOUEURS
Les Loups-Garous: un stratagème efficace pour se dédouaner d'une accusation, est de voter contre son partenaire. Encore faut-il que les Villageois le remarquent.
La Voyante: attention, si vous avez découvert un Loup-Garou, cela vaut peut-être la peine de vous dévoiler pour accuser le joueur, mais pas trop tôt !
La Petite Fille: personnage très puissant, mais très angoissant à jouer. N'hésitez pas à espionner! Cela fait peur mais il faut en profiter rapidement avant d'être éliminé.
Le Chasseur: II est toujours bon en cas d'accusation de se faire passer pour le Chasseur.
Cupidon: si vous vous désignez comme un des Amoureux, ne choisissez pas comme partenaire une trop "grande gueule".Le Capitaine: n'hésitez pas à vous présenter au poste de Capitaine, faites votre campagne. Mais si vous êtes Loup-Garou, ne soyez pas trop ouvertement candidat à ce poste. Soyez fier de ce poste, accrochez la carte au revers de votre vêtement.
La Sorcière: ce personnage devient plus puissant en fin de partie, ne gaspillez pas vos sorts.


--]]
if not WereWolf.IsCorrectVersion() then
    return
end

local L = WereWolf.L
local WereWolf = WereWolf
local Comm = WereWolf.Comm
local players = WereWolf.players



local UnitGUID, UnitClass = UnitGUID, UnitClass

local stereotypes = {
    -- add notion for lover and remove the role
    -- werewolf can be lovers
    werewolf = {
        Class = L["Werewolf"],
        Name = L["Werewolf"],
        Icon = 132224,
        Tips = L["Just kill"],
        Goal = L["Kill every peon"],
    },
    peon = {
        Class = L["Peon"],
        Name = L["Peon"],
        Icon = 132275,
        Tips = L["Just survive"],
        Goal = L["Survive to werewolf attacks"],
    },
    special = {
        hunter = {
            Class = L["Peon"],
            Name = L["Hunter"],
            Icon = 132217,
            Tips = L["Can point a player to come with him into death"],
            Goal = L["Survive to werewolf attacks"],
            isApplyed = false,
        },
        caty = {
            Class = L["Peon"],
            Name = L["Cathy"],
            Icon = 132311,
            Tips = L["Can spy the werewolf during night. Beware! do not be catch or you will be immediatly dead!"],
            Goal = L["Spy and survive to werewolf attacks"],
            isApplyed = false,
        },
        witch = {
            Class = L["Peon"],
            Name = L["Witch"],
            Icon = 132378,
            Tips = L["Can concoct poisonous or healing potion"],
            Goal = L["Survive to werewolf attacks"],
            isApplyed = false,
        },
        captain = {
            Class = L["Peon"],
            Name = L["Captain"],
            Icon = 132341,
            Tips = L["Vote count double. On death, point another player to become the new captain."],
            Goal = L["Survive to werewolf attacks"],
            isApplyed = false,
        },
        cupidon = {
            Class = L["Peon"],
            Name = L["Cupid"],
            Icon = 134131,
            Tips = L["Point two players to become the lovers"],
            Goal = L["Survive to werewolf attacks"],
            isApplyed = false,
        },
        rogue = {
            Class = L["Peon"],
            Name = L["Rogue"],
            Icon = 132320,
            Tips = L["During the first night, can choose its new role among two roles"],
            Goal = L["Survive to werewolf attacks"],
            isApplyed = false,
        }
    },
    seer = {
        Class = L["Peon"],
        Name = L["Seer"],
        Icon = 132327,
        Tips = L["Each night, can discover the true nature of players"],
        Goal = L["Survive to werewolf attacks"],
    },
    gamemaster = {
        Class = L["Game Master"],
        Name = L["Game Master"],
        Icon = 133073,
        Tips = L["You are the game master"],
        Goal = L["Manage the game!"],
    }
};


function WereWolf.IsPlayerKnown(playerName)
    for key, value in pairs(players) do
        if value.Name == playerName then
            return true
        end
    end
    return false
end

function WereWolf.AddPlayer(playerName)
    if (not (IsPlayerKnown(playerName))) then
        local player = {
            id = UnitGUID(playerName),
            Name = playerName,
            Class = select(2, UnitClass(playerName)),
            Role = nil,
            hasVoted = false,
            isAlive = true,
            isLover = false
        }
        table.insert(players, player)
    else
        -- player is already known
        WereWolf.prettyPrint("Player " .. playerName .. " has already joined the game")
    end
end

function WereWolf.RemovePlayer(playerName)
    local playerPos
    for key, value in pairs(players) do
        if value.Name == playerName then
            playerPos = key
            break
        end
    end

    if playerPos then
        table.remove(players, playerPos)
    end
end

--[[
Nombre de joueurs | Loups-Garous | Voyante | Villageois
                8 |            2 |      1  |          5 -> 2 speciaux
                9 |            2 |      1  |          6 -> 3 speciaux
               10 |            2 |      1  |          7 -> 3 speciaux
               11 |            2 |      1  |          8 -> 4 speciaux
               12 |            3 |      1  |          8 -> 4 speciaux
               13 |            3 |      1  |          9 -> 4 speciaux
               14 |            3 |      1  |         10 -> 5 speciaux
               15 |            3 |      1  |         11 -> 5 speciaux
               16 |            3 |      1  |         12 -> 6 speciaux
               17 |            3 |      1  |         13 -> 6 speciaux
               18 |            4 |      1  |         13 -> 6 speciaux --]]
local peonNumber = 0;
local specialPeonNumber = 0;
local werewolfNumber = 0;
local seerApplyed = false;
local isSetupStep = false;

function WereWolf.NextStep()
    if WereWolf.currentStep == "" or WereWolf.currentStep == "Vote" then
        WereWolf.SetNight()
    else
        if isSetupStep then            
            if WereWolf.currentStep == "Night" then
                WereWolf.WakeUpRogue()
            elseif WereWolf.currentStep == "Rogue" then
                WereWolf.WakeUpCupid()
            elseif WereWolf.currentStep == "Cupid" then
                WereWolf.WakeUpLovers()
            elseif WereWolf.currentStep == "Lovers" then
                WereWolf.WakeUpSeer()
            end
        else
            if WereWolf.CanContinue() then
                if WereWolf.currentStep == "Night" then
                    WereWolf.WakeUpSeer()
                elseif WereWolf.currentStep == "Seer" then
                    WereWolf.WakeUpWerewolves()
                elseif WereWolf.currentStep == "Werewolves" then
                    WereWolf.WakeUpWitch()
                elseif WereWolf.currentStep == "Witch" then
                    WereWolf.SetDay()
                elseif WereWolf.currentStep == "Day" then
                    WereWolf.Vote()
                end
            else
                WereWolf.GameEnds()
            end
        end
    end
end

function WereWolf.Reset()
    for key, value in pairs(players) do
        value.isAlive = true
    end
    for key, value in pairs(stereotypes.special) do
        value.isApplyed = false
    end
    for key, value in pairs(players) do
        value.Role = nil
    end
    seerApplyed = false
    peonNumber = 0
    specialPeonNumber = 0
    werewolfNumber = 0
    WereWolf.currentStep = ""
    isSetupStep = true
end

function WereWolf.SendPlayerTable()
    for _, value in pairs(players) do
        if value.id ~= WereWolf.me.id then
            Comm:SendCommand(value.Name, "add_player", value)
        end
    end
end

function WereWolf.StartAsPlayer()
    WereWolf.Reset()
    WereWolf.SetRoleToAllPlayer()
    WereWolf.SendRoleToAllPlayer()
end

function WereWolf.GameEnds()
    local alivePeon = 0
    local aliveWerewolf = 0
    local msg = L["win"]
    for key, value in pairs(players) do
        if value.isAlive == true then
            if value.Role.Class == L["Peon"] then
                alivePeon = alivePeon + 1
            elseif value.Role.Class == L["Werewolf"] then
                aliveWerewolf = aliveWerewolf + 1
            else
                WereWolf.printDebug("unknown role : "..value.Role.Class)
            end
        end
    end
    if alivePeon == 0 and aliveWerewolf > 0 then
        msg = L["Werewolves"].." "..msg.."!"
    elseif alivePeon > 0 and aliveWerewolf == 0 then
        msg = L["Peons"].." "..msg.."!"
    end
    for key, value in pairs(players) do
        Comm:SendCommand(value.Name, "game_ends", msg)
    end
end


function WereWolf.CanContinue()
    local ret = true
    if(WereWolf.isDevVersion) then
        return false
    end
    --[[ 
        CONDITIONS DE VICTOIRE
        Les Villageois gagnent dès qu'ils réussissent à éliminer le dernier Loup-Garou.
        Les Loups Garous gagnent s'ils éliminent le dernier des villageois.
        Cas particulier:
        si les Amoureux sont 1 Loup-Garou + 1 Villageois, ils gagnent dès qu'ils ont éliminé tous les autres.
    --]]
    local werewolfcount = 0
    local peoncount = 0
    for key, value in pairs(players) do
        if value.isAlive then
            if value.Role.class == L["Werewolf"] then
                werewolfcount = werewolfcount + 1
            elseif value.Role.class == L["Peon"] then
                peoncount = peoncount + 1
            end
        end
    end
    if werewolfcount > 0 and peoncount == 0 then
        ret = false
    elseif werewolfcount == 0 and peoncount > 0 then
        ret = false
    end

    return ret
end

function WereWolf.SendRoleToAllPlayer()
    for _, value in pairs(players) do
        if value.id ~= WereWolf.me.id then
            Comm:SendCommand(value.Name, "player_role", value.Role)
        end
    end
end

function WereWolf.SetNight()
    WereWolf.currentStep = "Night"

    WereWolf.prettyPrint(L["The night fall on the village and everyone fells asleep"])
    for key, value in pairs(players) do
        if(value.Role and value.Role.Class ~= L["Game Master"]) then
            Comm:SendCommand(value.Name, "set_night")
        end
    end
end

function WereWolf.SetDay()
    --[[
        4 - Le meneur réveille tout le village.
        Le meneur dit: "c'est le matin, le village se réveille, tout le monde se réveille et ouvre les yeux, tout le monde sauf..."
        Le meneur désigne alors le ou les joueurs qui ont été Victimes des Loups-Garous ou de la Sorcière durant la nuit.
        Ce ou ces joueurs révèlent leur carte car ils sont éliminés du jeu. 
        Il ne pourront plus communiquer avec les autres joueurs de quelque manière que ce soit. 
        Si un de ces joueurs est le Chasseur, il a le droit de répliquer et de tuer immédiatement un autre joueur de son choix.
        Si un des joueurs est un des deux Amoureux, l'autre Amoureux meurt de chagrin immédiatement.
        Si un des joueurs est le Capitaine, il désigne son successeur.
    --]]
    WereWolf.currentStep = "Day"
    isSetupStep = false
    WereWolf.prettyPrint(L["The day rises again with its shinny sun and its grim discovery..."])
    for key, value in pairs(players) do
        if(value.Role.Class ~= L["Game Master"]) then
            Comm:SendCommand(value.Name, "set_day")
        end
    end

end

function WereWolf.Vote()
    --[[
    6 - Le village vote.
    Les joueurs doivent éliminer un joueur suspecté d'être un Loup-Garou.
    Au signal du meneur, chaque joueur pointe son doigt dans la direction du joueur qu'il souhaite éliminer. 
    Le joueur qui a la majorité des voix est éliminé. N'oubliez pas que la voix du Capitaine compte double.
    En cas d'égalité, s'il est présent, le vote du Capitaine désigne la victime. Sinon, les joueurs votent à nouveau (y compris les joueurs en cause) pour départager les ex-aequo.
    S'il y a toujours égalité, aucun joueur n'est éliminé.
    Le joueur éliminé révèle sa carte et ne pourra plus communiquer avec les autres joueurs d'aucune manière.
    --]]
    WereWolf.currentStep = "Vote"
    isSetupStep = false
    
    WereWolf.prettyPrint(L["Villagers vote! Point the one who killed!"])
    for key, value in pairs(players) do
        if value.isAlive then
            Comm:SendCommand(value.Name, "set_vote")
        end
    end

end

local function IsRolePick(role)
    local rolePick = false
    for key, value in pairs(players) do
        if(value.Role.Name == role and value.isAlive) then
            rolePick = true
            break
        end
    end

    return rolePick
end 

function WereWolf.WakeUpRogue()
    WereWolf.currentStep = "Rogue"

    if IsRolePick(L["Rogue"]) then
        WereWolf.prettyPrint(L["Rogue, wake up and do your sneaky thing!"])
        for key, value in pairs(players) do
            Comm:SendCommand(value.Name, "set_rogue", value.Role)
        end
    else
        WereWolf.NextStep()
    end
end

function WereWolf.WakeUpCupid()
    WereWolf.currentStep = "Cupid"
    if IsRolePick(L["Cupid"]) then
        WereWolf.prettyPrint(L["Cupid, wake up and throw your arrows!"])
        for key, value in pairs(players) do
            Comm:SendCommand(value.Name, "set_cupid", value.Role)
        end
    else
        WereWolf.NextStep()
    end
end

function WereWolf.WakeUpLovers()
    WereWolf.currentStep = "Lovers"
    if IsRolePick(L["Lover"]) then
        WereWolf.prettyPrint(L["Lovers, wake up and face your beloved!"])
        for key, value in pairs(players) do
            Comm:SendCommand(value.Name, "set_lover", value.Role)
        end
    else
        WereWolf.NextStep()
    end
end

function WereWolf.WakeUpSeer()
    WereWolf.currentStep = "Seer"
    isSetupStep = false

    if IsRolePick(L["Seer"]) then
        for key, value in pairs(players) do
            if value.isAlive then
                Comm:SendCommand(value.Name, "set_seer", value.Role)
            end
        end
    else
        WereWolf.NextStep()
    end
end

function WereWolf.WakeUpWerewolves()
    WereWolf.currentStep = "Werewolves"
    isSetupStep = false
    WereWolf.prettyPrint(L["Werewolves, wake up and eat, eat till your hunger are filled!"])
    for key, value in pairs(players) do
        if value.isAlive then
            Comm:SendCommand(value.Name, "set_werwolves", value.Role)
        end
    end
end

function WereWolf.WakeUpWitch()
    WereWolf.currentStep = "Witch"
    isSetupStep = false

    if IsRolePick(L["Witch"])  then
        for key, value in pairs(players) do
            if value.isAlive then
                Comm:SendCommand(value.Name, "set_witch", value.Role)
            end
        end
    else
        WereWolf.NextStep()
    end
end

-- select among werewolf and peon role and set it to player
local function SetRoleToPlayer(player)
    local classType = math.random(#players)
    if ((classType% 2) == 0) then -- werewolf
        if not (werewolfNumber == #players / 4) then
            WereWolf.SetSpecificRoleToPlayer(player, stereotypes.werewolf)
            werewolfNumber = werewolfNumber + 1
        else -- peon
            WereWolf.SetSpecificRoleToPlayer(player, stereotypes.peon)
            peonNumber = peonNumber + 1
        end
    else -- peon
        WereWolf.SetSpecificRoleToPlayer(player, stereotypes.peon)
        peonNumber = peonNumber + 1
    end
end

-- Apply the given role to player
function WereWolf.SetSpecificRoleToPlayer(player, role)
    player.Role = {
        Class = role.Class,
        Name  = role.Name,
        Icon  = role.Icon,
        Tips  = role.Tips,
        Goal  = role.Goal,
    };
end

function WereWolf.SetRoleToAllPlayer()
    for key, value in pairs(players) do
        if value.Role == nil then
            SetRoleToPlayer(value)
        end
    end

    for key, value in pairs(players) do
        if value.Role.Class == stereotypes.peon.Class then
            if not(seerApplyed) then
                WereWolf.SetSpecificRoleToPlayer(value, stereotypes.seer)
                seerApplyed = true
            else
                if not(specialPeonNumber == #players / 4) then
                    local availableClass = {}
                    for key, value in pairs(stereotypes.special) do
                        if value.isApplyed == false then
                            table.insert(availableClass, value)
                        end
                    end
                    
                    if #availableClass > 0 then
                        local classType = math.random(#availableClass)
                        local newRole = availableClass[classType]
                        WereWolf.SetSpecificRoleToPlayer(value, newRole)
                        specialPeonNumber = specialPeonNumber + 1

                        for key, value in pairs(stereotypes.special) do
                            if value.Name == newRole.Name then
                                value.isApplyed = true
                                break
                            end
                        end
                    end
                end
            end
        end
    end
end

function WereWolf.GetAvailabelRoleForRogue()
    local possibleRole = {}

    for i=0,2 do 
        if not (werewolfNumber == #players / 4) then
            table.insert(possibleRole, stereotypes.werewolf)
        elseif not(specialPeonNumber == #players / 4) then
            local availableClass = {}
            for key, value in pairs(stereotypes.special) do
                if value.isApplyed == false then
                    table.insert(availableClass, value)
                end
            end
            
            if #availableClass > 0 then
                local classType = math.random(#availableClass)
                local newRole = availableClass[classType]
                table.insert(possibleRole, newRole)
            end
        else
            table.insert(possibleRole, stereotypes.peon)
        end
    end

    return possibleRole
end

function WereWolf.ManageDeathOfPlayer(player)
    if player.Role.Class == L["Hunter"] then
        -- another should die
        -- WereWolf.AllowPlayerToPointFollower(player)
    elseif player.Role.Class == L["Captain"] then
        -- point the new captain
        -- WereWolf.AllowPlayerToPointSuccessor(player)
    elseif player.Role.Class == L["Lover"] then
        -- the other lover die as well
        for key, value in pairs(players) do
            if not (value == player) and value.Role.Class == L["Lover"] then
                -- WerWolf.SignifyDeathToPlayer(value)
                value.isAlive = false
                break
            end
        end
    end
    player.isAlive = false
end
